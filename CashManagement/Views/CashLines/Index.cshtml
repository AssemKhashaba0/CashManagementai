@model IEnumerable<CashManagement.Controllers.CashLineViewModel>
@{
    Layout = "/Views/Shared/_LayoutDashbord.cshtml";
    var amount = ViewBag.Amount;
    var transactionType = ViewBag.TransactionType;
}

<style>
    /* تعريف المتغيرات للألوان الجديدة */
    :root {
        --bg: #FDFDFD; /* عاجي فاتح */
        --primary: #1D4ED8; /* أزرق نيلي */
        --text: #111827; /* أسود ناعم */
        --secondary-button: #FACC15; /* ذهبي ناعم */
        --light-gray: #F3F4F6; /* رمادي فاتح */
        --border-color: rgba(17, 24, 39, 0.1); /* أسود ناعم شفاف للحدود */
        --shadow-color: rgba(0, 0, 0, 0.05); /* ظل خفيف */
        --success-text: #22C55E; /* أخضر للحالة الناجحة */
        --warning-text: #FACC15; /* أصفر للحالة التحذيرية */
        --danger-text: #EF4444; /* أحمر للحالة الخطيرة */
    }

    /* تطبيق الخط واتجاه النص */
    body {
        font-family: 'Inter', 'Cairo', sans-serif;
        direction: rtl;
        background-color: var(--bg); /* استخدام اللون العاجي الفاتح للخلفية */
        color: var(--text); /* استخدام الأسود الناعم للنصوص الأساسية */
    }

    h1, h2, h3, h4, h5, h6 {
        color: var(--text); /* التأكد من أن العناوين تستخدم لون النص الأساسي */
    }

    /* الأنماط العامة للحاوية والبطاقات */
    .container-fluid {
        padding: 1.5rem; /* Consistent padding */
    }

    .card {
        background-color: white; /* بطاقات بيضاء */
        border: 1px solid var(--border-color); /* حدود خفيفة */
        border-radius: 0.5rem; /* زوايا مستديرة للبطاقات */
        box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color);
        margin-bottom: 1.5rem; /* مسافة بين البطاقات */
    }

    .card-header {
        background-color: var(--light-gray); /* ترويسة البطاقة بلون رمادي فاتح */
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
        font-weight: 600; /* سمك الخط لعنوان البطاقة */
        color: var(--text);
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-footer {
        background-color: var(--light-gray);
        border-top: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
    }

    /* أنماط أزرار النموذج */
    .form-control, .form-select {
        border-color: var(--border-color); /* لون الحدود لعناصر النموذج */
        color: var(--text);
        background-color: white;
    }

    .btn-primary {
        background-color: var(--primary); /* أزرق نيلي للأزرار الأساسية */
        border-color: var(--primary);
        color: white;
    }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary) 90%, black); /* تدرج أغمق قليلاً عند التمرير */
            border-color: color-mix(in srgb, var(--primary) 90%, black);
        }

    .btn-warning {
        background-color: var(--secondary-button); /* ذهبي ناعم للزر الثانوي */
        border-color: var(--secondary-button);
        color: var(--text); /* نص داكن للزر الذهبي */
    }

        .btn-warning:hover {
            background-color: color-mix(in srgb, var(--secondary-button) 90%, black);
            border-color: color-mix(in srgb, var(--secondary-button) 90%, black);
        }

    .btn-info { /* زر التفاصيل */
        background-color: #3ABFF8; /* أزرق فاتح */
        border-color: #3ABFF8;
        color: white;
    }

        .btn-info:hover {
            background-color: color-mix(in srgb, #3ABFF8 90%, black);
            border-color: color-mix(in srgb, #3ABFF8 90%, black);
        }

    .btn-success {
        background-color: var(--success-text); /* أخضر للنجاح */
        border-color: var(--success-text);
        color: white;
    }

        .btn-success:hover {
            background-color: color-mix(in srgb, var(--success-text) 90%, black);
            border-color: color-mix(in srgb, var(--success-text) 90%, black);
        }

    .btn-danger {
        background-color: var(--danger-text); /* أحمر للخطر */
        border-color: var(--danger-text);
        color: white;
    }

        .btn-danger:hover {
            background-color: color-mix(in srgb, var(--danger-text) 90%, black);
            border-color: color-mix(in srgb, var(--danger-text) 90%, black);
        }

    /* أنماط التقدم (Progress Bars) */
    .progress {
        background-color: var(--light-gray); /* خلفية شريط التقدم */
        height: 0.5rem; /* ارتفاع أقل */
        border-radius: 0.25rem;
    }

    .progress-bar {
        background-color: var(--primary); /* لون شريط التقدم */
    }

    /* أنماط الشارات (Badges) */
    .badge {
        font-weight: 500; /* خط أخف للشارات */
        padding: 0.35em 0.65em;
        border-radius: 0.375rem;
        font-size: 0.75rem;
    }

        .badge.bg-success {
            background-color: var(--success-text) !important;
            color: white;
        }

        .badge.bg-warning {
            background-color: var(--warning-text) !important;
            color: var(--text); /* نص داكن للتحذير */
        }

        .badge.bg-danger {
            background-color: var(--danger-text) !important;
            color: white;
        }

    /* أنماط الرسائل التنبيهية */
    .alert-success {
        background-color: #D1FAE5; /* أخضر فاتح */
        color: #065F46; /* أخضر داكن للنص */
        border-color: #A7F3D0;
    }

    .alert-danger {
        background-color: #FEE2E2; /* أحمر فاتح */
        color: #991B1B; /* أحمر داكن للنص */
        border-color: #FECACA;
    }
</style>

<div class="container-fluid">
    <h2 class="text-center mb-4">إدارة الخطوط النقدية</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card mb-4 p-4">
        <form asp-action="Index" method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="amount" class="form-label">المبلغ</label>
                <input type="number" step="0.01" min="0" name="amount" id="amount" class="form-control" placeholder="أدخل المبلغ" value="@(amount ?? "")" />
            </div>
            <div class="col-md-3">
                <label for="transactionType" class="form-label">نوع المعاملة</label>
                <select name="transactionType" id="transactionType" class="form-select">
                    <option value="">اختر النوع</option>
                    <option value="@TransactionType.Withdraw" selected="@(transactionType == TransactionType.Withdraw)">سحب</option>
                    <option value="@TransactionType.Deposit" selected="@(transactionType == TransactionType.Deposit)">إيداع</option>
                </select>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search me-2"></i> بحث
                </button>
            </div>
            <div class="col-md-4 d-grid gap-2 d-md-flex justify-content-md-end">
                <a asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i> إضافة خط جديد
                </a>
                <form asp-action="ResetLimits" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-warning" onclick="return confirm('هل أنت متأكد من إعادة تعيين جميع الحدود اليومية والشهرية لجميع الخطوط النقدية؟ هذا الإجراء لا يمكن التراجع عنه.');">
                        <i class="bi bi-arrow-clockwise me-2"></i> إعادة تعيين الحدود
                    </button>
                </form>
            </div>
        </form>
    </div>

    @if (Model.Any())
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var cashLine in Model)
            {
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="cashline-card">
                        <div class="card-header">
                            <h5 class="card-title">@cashLine.PhoneNumber</h5>
                            <span class="status-badge status-@cashLine.Status.ToString().ToLower()">
                                @(cashLine.Status == AccountStatus.Active ? "نشط" : 
                                  cashLine.Status == AccountStatus.Frozen ? "مجمد" : "غير نشط")
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="info-row">
                                <span class="info-label">اسم المالك:</span>
                                <span class="info-value">@cashLine.OwnerName</span>
                            </div>
                            
                            @if (User.IsInRole("Admin"))
                            {
                                <div class="info-row">
                                    <span class="info-label">الرقم القومي:</span>
                                    <span class="info-value">@cashLine.NationalId</span>
                                </div>
                            }
                            
                            <div class="info-row">
                                <span class="info-label">نوع الشبكة:</span>
                                <span class="info-value">@cashLine.NetworkType</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">الرصيد الحالي:</span>
                                <span class="info-value balance">@cashLine.CurrentBalance.ToString("C")</span>
                            </div>
                            
                            <!-- باقي التفاصيل للجميع -->
                            <div class="limits-section">
                                <div class="limit-item">
                                    <div class="limit-header">
                                        <span class="limit-label">الحد اليومي للسحب</span>
                                        <span class="limit-value">@(Math.Max(0, cashLine.DailyWithdrawRemaining).ToString("C")) / @cashLine.DailyWithdrawLimit.ToString("C")</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: @(Math.Min(100, Math.Max(0, cashLine.DailyWithdrawRemainingPercentage)))%" aria-valuenow="@(Math.Min(100, Math.Max(0, cashLine.DailyWithdrawRemainingPercentage)))" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="limit-item">
                                    <div class="limit-header">
                                        <span class="limit-label">الحد اليومي للإيداع</span>
                                        <span class="limit-value">@(Math.Max(0, cashLine.DailyDepositRemaining).ToString("C")) / @cashLine.DailyDepositLimit.ToString("C")</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: @(Math.Min(100, Math.Max(0, cashLine.DailyDepositRemainingPercentage)))%" aria-valuenow="@(Math.Min(100, Math.Max(0, cashLine.DailyDepositRemainingPercentage)))" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="limit-item">
                                    <div class="limit-header">
                                        <span class="limit-label">الحد الشهري للسحب</span>
                                        <span class="limit-value">@(Math.Max(0, cashLine.MonthlyWithdrawRemaining).ToString("C")) / @cashLine.MonthlyWithdrawLimit.ToString("C")</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: @(Math.Min(100, Math.Max(0, cashLine.MonthlyWithdrawRemainingPercentage)))%" aria-valuenow="@(Math.Min(100, Math.Max(0, cashLine.MonthlyWithdrawRemainingPercentage)))" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="limit-item">
                                    <div class="limit-header">
                                        <span class="limit-label">الحد الشهري للإيداع</span>
                                        <span class="limit-value">@(Math.Max(0, cashLine.MonthlyDepositRemaining).ToString("C")) / @cashLine.MonthlyDepositLimit.ToString("C")</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: @(Math.Min(100, Math.Max(0, cashLine.MonthlyDepositRemainingPercentage)))%" aria-valuenow="@(Math.Min(100, Math.Max(0, cashLine.MonthlyDepositRemainingPercentage)))" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer d-flex flex-wrap gap-2 justify-content-center">
                            <a asp-action="Details" asp-route-id="@cashLine.Id" class="btn btn-info btn-sm">
                                <i class="bi bi-info-circle me-1"></i> التفاصيل
                            </a>
                            
                            @if (User.IsInRole("Admin"))
                            {
                                <a asp-action="Edit" asp-route-id="@cashLine.Id" class="btn btn-primary btn-sm">
                                    <i class="bi bi-pencil me-1"></i> تعديل
                                </a>
                                @if (cashLine.Status == AccountStatus.Active)
                                {
                                    <form asp-action="Freeze" asp-route-id="@cashLine.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('هل أنت متأكد من تجميد هذا الخط؟');">
                                            <i class="bi bi-lock me-1"></i> تجميد
                                        </button>
                                    </form>
                                }
                                else if (cashLine.Status == AccountStatus.Frozen)
                                {
                                    <form asp-action="Unfreeze" asp-route-id="@cashLine.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('هل أنت متأكد من إلغاء تجميد هذا الخط؟');">
                                            <i class="bi bi-unlock me-1"></i> إلغاء التجميد
                                        </button>
                                    </form>
                                }
                            }
                            
                            @if (User.IsInRole("Employee") && cashLine.Status == AccountStatus.Active)
                            {
                                <a asp-controller="CashTransactions" asp-action="Withdraw" asp-route-cashLineId="@cashLine.Id" class="btn btn-success btn-sm" onclick="return confirm('هل أنت متأكد من إجراء عملية السحب؟');">
                                    <i class="bi bi-download me-1"></i> سحب
                                </a>
                                <a asp-controller="CashTransactions" asp-action="Deposit" asp-route-cashLineId="@cashLine.Id" class="btn btn-primary btn-sm" onclick="return confirm('هل أنت متأكد من إجراء عملية الإيداع؟');">
                                    <i class="bi bi-upload me-1"></i> إيداع
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center" role="alert">
            لا توجد خطوط نقدية متاحة لعرضها.
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
}


