@model IEnumerable<CashManagement.Controllers.CashTransactionViewModel>
@{
    Layout = "/Views/Shared/_LayoutDashbord.cshtml";
    var cashLines = ViewBag.CashLines as List<dynamic>;
}

<div class="container-fluid">
    <h2 class="text-center mb-4">إدارة العمليات النقدية</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="Index" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="searchString" class="form-label">البحث برقم المستلم أو الوصف</label>
                    <input type="text" name="searchString" id="searchString" class="form-control" value="@ViewBag.SearchString" />
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">تاريخ البداية</label>
                    <input type="date" name="startDate" id="startDate" class="form-control" value="@(ViewBag.StartDate?.ToString("yyyy-MM-dd"))" />
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">تاريخ النهاية</label>
                    <input type="date" name="endDate" id="endDate" class="form-control" value="@(ViewBag.EndDate?.ToString("yyyy-MM-dd"))" />
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">نوع العملية</label>
                    <select name="type" id="type" class="form-select">
                        <option value="">الكل</option>
                        <option value="Withdraw">سحب</option>
                        <option value="Deposit">إيداع</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">الحالة</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">الكل</option>
                        <option value="Completed">مكتمل</option>
                        <option value="Frozen">مجمد</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="cashLineId" class="form-label">الخط النقدي</label>
                    <select name="cashLineId" id="cashLineId" class="form-select">
                        <option value="">الكل</option>
                        @if (cashLines != null)
                        {
                            foreach (var cashLine in cashLines)
                            {
                                <option value="@cashLine.Id">@cashLine.PhoneNumber</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">بحث</button>
                    <a asp-action="ExportTransactions" class="btn btn-success">تصدير إلى Excel</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>رقم العملية</th>
                            <th>رقم الخط</th>
                            <th>المبلغ</th>
                            <th>الرسوم</th>
                            <th>المبلغ الصافي</th>
                            <th>نوع العملية</th>
                            <th>الحالة</th>
                            <th>المستخدم</th>
                            <th>التاريخ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var transaction in Model)
                        {
                            <tr>
                                <td>@transaction.Id</td>
                                <td>@transaction.CashLinePhoneNumber</td>
                                <td>@transaction.Amount.ToString("C")</td>
                                <td>@transaction.Fees.ToString("C")</td>
                                <td>@transaction.NetAmount.ToString("C")</td>
                                <td>@(transaction.TransactionType == TransactionType.Withdraw ? "سحب" : "إيداع")</td>
                                <td>
                                    <span class="badge @(transaction.Status == TransactionStatus.Completed ? "bg-success" : "bg-warning")">
                                        @(transaction.Status == TransactionStatus.Completed ? "مكتمل" : "مجمد")
                                    </span>
                                </td>
                                <td>@transaction.UserName</td>
                                <td>@transaction.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@transaction.Id" class="btn btn-info btn-sm">التفاصيل</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
}